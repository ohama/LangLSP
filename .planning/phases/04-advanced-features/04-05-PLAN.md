---
phase: 04-advanced-features
plan: 05
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - documentation/tutorial/10-rename.md
autonomous: true

must_haves:
  truths:
    - "Tutorial explains Rename Symbol concept with VS Code usage example"
    - "Tutorial shows LSP protocol for textDocument/rename and prepareRename"
    - "Tutorial walks through WorkspaceEdit construction with TextEdit arrays"
    - "Tutorial includes working code examples matching actual Rename.fs implementation"
    - "Tutorial covers rename safety (prepareRename validation) and preview"
  artifacts:
    - path: "documentation/tutorial/10-rename.md"
      provides: "Rename Symbol tutorial in Korean (TUT-10)"
      min_lines: 400
  key_links:
    - from: "documentation/tutorial/10-rename.md"
      to: "src/LangLSP.Server/Rename.fs"
      via: "code examples matching implementation"
      pattern: "handleRename|handlePrepareRename"
---

<objective>
Write the Rename Symbol Korean tutorial (TUT-10) explaining how to implement textDocument/rename.

Purpose: Tutorial readers learn how to implement safe symbol renaming with preview, understand WorkspaceEdit construction, and handle prepareRename validation.
Output: documentation/tutorial/10-rename.md (~500-700 lines, Korean)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/LangLSP.Server/Rename.fs
@src/LangLSP.Server/References.fs
@src/LangLSP.Server/Protocol.fs
@documentation/tutorial/09-find-references.md
@documentation/tutorial/08-definition.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Rename Symbol tutorial (10-rename.md)</name>
  <files>documentation/tutorial/10-rename.md</files>
  <action>
Create `documentation/tutorial/10-rename.md` in Korean, following established tutorial style.

Title: `# Rename Symbol 구현하기`

Opening paragraph: Explain Rename Symbol — safely renaming a variable or function across all its usages simultaneously. Emphasize that this is a refactoring feature that prevents manual find-and-replace errors.

Structure:

## 목차
1. Rename Symbol이란
2. LSP 프로토콜
3. WorkspaceEdit 이해하기
4. prepareRename 구현
5. 레퍼런스 수집과 이름 변경
6. 바인딩 사이트 이름 스팬 계산
7. handleRename 구현
8. Protocol.fs 헬퍼 함수
9. Server.fs 통합
10. 테스트 작성
11. 주의사항과 엣지 케이스

## Content for each section:

**1. Rename Symbol이란**
- What it does: rename a symbol and all its references at once
- VS Code usage: F2 or right-click -> "Rename Symbol"
- Show before/after example:
  ```
  Before:                        After (rename x → count):
  let x = 42 in                  let count = 42 in
  let y = x + 1 in               let y = count + 1 in
  x + y                          count + y
  ```
- Benefits: avoids manual errors, handles shadowing correctly

**2. LSP 프로토콜**
- Two requests: textDocument/prepareRename and textDocument/rename
- prepareRename: client asks "can I rename here?" before showing rename dialog
  - Request: TextDocumentPositionParams
  - Response: { range, placeholder } or null
- rename: client sends new name, server returns edits
  - Request: RenameParams (TextDocumentIdentifier, Position, NewName)
  - Response: WorkspaceEdit
- Server capability: RenameProvider with PrepareProvider = true

**3. WorkspaceEdit 이해하기**
- WorkspaceEdit structure: changes map (URI -> TextEdit[])
- TextEdit: { Range, NewText }
- Why `changes` map not `documentChanges`: simpler for single-file scope
- Show JSON example of a WorkspaceEdit
- How VS Code applies edits: shows preview, user confirms, all edits applied atomically

**4. prepareRename 구현**
- Show handlePrepareRename code
- Explain validation logic: cursor must be on Var, Let, LetRec, Lambda, or LambdaAnnot
- Return range of the identifier and current name as placeholder
- Return None for non-renameable positions (numbers, keywords, operators)

**5. 레퍼런스 수집과 이름 변경**
- Rename = References + Definition with text replacement
- Reuse collectReferencesForBinding from References module
- Collect ALL locations that need to change: definition binding + all Var references
- Must handle both "rename from usage" and "rename from definition" scenarios

**6. 바인딩 사이트 이름 스팬 계산**
- Challenge: Var spans cover just the name, but definition spans cover whole expression
- Need to compute name-only span for definition binding site
- Show getNameSpanFromBinding helper or source text search approach
- Examples: "let x" -> name at column 4, "let rec f" -> name at column 8, "fun x" -> name at column 4

**7. handleRename 구현**
- Show full handleRename code
- Step-by-step walkthrough:
  1. Parse AST
  2. Find node at cursor
  3. Determine variable name and definition span
  4. Collect scoped references
  5. Build name span for definition
  6. Create TextEdit[] for all locations
  7. Build WorkspaceEdit with createWorkspaceEdit

**8. Protocol.fs 헬퍼 함수**
- Show createTextEdit and createWorkspaceEdit helpers
- Why these are useful (reused by Code Actions too)

**9. Server.fs 통합**
- Show capability registration with PrepareProvider = true
- Show both handler functions
- Explain the two-step flow: client calls prepareRename first, then rename

**10. 테스트 작성**
- Show 2-3 test examples
- Test rename with multiple occurrences
- Test prepareRename validation (renameable vs non-renameable)
- Test helper pattern

**11. 주의사항과 엣지 케이스**
- Shadowing: rename must only affect the specific binding's references
- TextEdit ranges must not overlap
- Empty NewName handling
- Parse error graceful degradation

STYLE: Same as 08-definition.md and 09-find-references.md. Korean, code examples, ~500-700 lines.
  </action>
  <verify>
File exists at documentation/tutorial/10-rename.md with 400+ lines. Contains Korean text, code examples, all 11 sections.
  </verify>
  <done>
Tutorial 10-rename.md written in Korean covering Rename Symbol concept, LSP protocol (rename + prepareRename), WorkspaceEdit construction, implementation walkthrough, and tests (TUT-10).
  </done>
</task>

</tasks>

<verification>
- documentation/tutorial/10-rename.md exists with 400+ lines
- All 11 sections present
- Code examples match actual Rename.fs and Protocol.fs implementation
- Korean language throughout
</verification>

<success_criteria>
- TUT-10 requirement met: tutorial shows how to implement Rename Symbol with code examples
- Covers both prepareRename and rename flows
- Explains WorkspaceEdit construction clearly
- Covers shadowing edge case in rename context
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-features/04-05-SUMMARY.md`
</output>
