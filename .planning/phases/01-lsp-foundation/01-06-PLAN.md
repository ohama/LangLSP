---
phase: 01-lsp-foundation
plan: 06
type: execute
wave: 4
depends_on: ["01-05"]
files_modified:
  - client/package.json
  - client/src/extension.ts
  - client/tsconfig.json
  - client/.vscodeignore
  - client/language-configuration.json
autonomous: true
user_setup:
  - service: npm
    why: "VS Code extension development"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "VS Code extension activates when .fun file is opened"
    - "Extension spawns F# LSP server process"
    - "Extension communicates with server via stdin/stdout"
    - "Syntax errors show red squiggles in VS Code"
    - "Type errors show red squiggles in VS Code"
  artifacts:
    - path: "client/package.json"
      provides: "VS Code extension manifest"
      contains: "funlang"
    - path: "client/src/extension.ts"
      provides: "Extension activation and LanguageClient"
      contains: "LanguageClient"
    - path: "client/language-configuration.json"
      provides: "Basic language config (comments, brackets)"
  key_links:
    - from: "client/src/extension.ts"
      to: "src/LangLSP.Server"
      via: "server executable path"
      pattern: "LangLSP.Server"
    - from: "client/package.json"
      to: "vscode-languageclient"
      via: "npm dependency"
      pattern: "vscode-languageclient"
---

<objective>
Create the VS Code extension client that activates on .fun files and connects to the F# LSP server.

Purpose: This is the user-facing component that makes the LSP features visible in VS Code.
Output: Working VS Code extension that starts the LSP server and displays diagnostics.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-lsp-foundation/01-RESEARCH.md
@.planning/phases/01-lsp-foundation/01-01-SUMMARY.md
@.planning/phases/01-lsp-foundation/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VS Code Extension Package</name>
  <files>
    client/package.json
    client/tsconfig.json
    client/.vscodeignore
  </files>
  <action>
Create `client/` directory structure for VS Code extension.

Create `client/package.json`:
```json
{
  "name": "funlang",
  "displayName": "FunLang",
  "description": "FunLang language support with LSP",
  "version": "0.1.0",
  "publisher": "funlang",
  "engines": {
    "vscode": "^1.74.0"
  },
  "categories": ["Programming Languages"],
  "activationEvents": [],
  "main": "./out/extension.js",
  "contributes": {
    "languages": [{
      "id": "funlang",
      "aliases": ["FunLang", "funlang"],
      "extensions": [".fun"],
      "configuration": "./language-configuration.json"
    }]
  },
  "scripts": {
    "vscode:prepublish": "npm run compile",
    "compile": "tsc -p ./",
    "watch": "tsc -watch -p ./"
  },
  "dependencies": {
    "vscode-languageclient": "^9.0.1"
  },
  "devDependencies": {
    "@types/vscode": "^1.74.0",
    "@types/node": "^20.0.0",
    "typescript": "^5.0.0"
  }
}
```

Note: VS Code 1.74.0+ auto-activates for contributed languages; empty activationEvents is correct.

Create `client/tsconfig.json`:
```json
{
  "compilerOptions": {
    "module": "commonjs",
    "target": "ES2020",
    "outDir": "out",
    "lib": ["ES2020"],
    "sourceMap": true,
    "rootDir": "src",
    "strict": true,
    "esModuleInterop": true
  },
  "exclude": ["node_modules"]
}
```

Create `client/.vscodeignore`:
```
.vscode/**
src/**
node_modules/**
tsconfig.json
```

Run `npm install` in client directory to install dependencies.
  </action>
  <verify>
`cd client && npm install` succeeds without errors
  </verify>
  <done>
VS Code extension package configured with vscode-languageclient dependency
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Language Configuration</name>
  <files>client/language-configuration.json</files>
  <action>
Create `client/language-configuration.json` for basic editing features:

```json
{
  "comments": {
    "lineComment": "//"
  },
  "brackets": [
    ["{", "}"],
    ["[", "]"],
    ["(", ")"]
  ],
  "autoClosingPairs": [
    { "open": "{", "close": "}" },
    { "open": "[", "close": "]" },
    { "open": "(", "close": ")" },
    { "open": "\"", "close": "\"", "notIn": ["string"] }
  ],
  "surroundingPairs": [
    ["{", "}"],
    ["[", "]"],
    ["(", ")"],
    ["\"", "\""]
  ],
  "folding": {
    "markers": {
      "start": "^\\s*//\\s*#region",
      "end": "^\\s*//\\s*#endregion"
    }
  }
}
```

Note: FunLang uses // for comments (if supported). Adjust based on actual FunLang syntax.
  </action>
  <verify>
File exists at `client/language-configuration.json` with valid JSON
  </verify>
  <done>
Language configuration provides basic editing support (brackets, comments)
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Extension Activation</name>
  <files>client/src/extension.ts</files>
  <action>
Create `client/src/` directory.

Create `client/src/extension.ts`:

```typescript
import * as path from 'path';
import { workspace, ExtensionContext } from 'vscode';
import {
  LanguageClient,
  LanguageClientOptions,
  ServerOptions
} from 'vscode-languageclient/node';

let client: LanguageClient;

export function activate(context: ExtensionContext) {
  // Path to the F# LSP server executable
  // After `dotnet publish`, the executable is in the publish folder
  const serverPath = context.asAbsolutePath(
    path.join('server', 'LangLSP.Server')
  );

  // For development: use dotnet run
  // For production: use published executable
  const serverOptions: ServerOptions = {
    run: {
      command: 'dotnet',
      args: ['run', '--project', context.asAbsolutePath(path.join('..', 'src', 'LangLSP.Server', 'LangLSP.Server.fsproj'))],
      options: { cwd: context.asAbsolutePath('..') }
    },
    debug: {
      command: 'dotnet',
      args: ['run', '--project', context.asAbsolutePath(path.join('..', 'src', 'LangLSP.Server', 'LangLSP.Server.fsproj'))],
      options: { cwd: context.asAbsolutePath('..') }
    }
  };

  // Client options: what documents to sync
  const clientOptions: LanguageClientOptions = {
    documentSelector: [{ scheme: 'file', language: 'funlang' }],
    synchronize: {
      fileEvents: workspace.createFileSystemWatcher('**/*.fun')
    }
  };

  // Create and start the client
  client = new LanguageClient(
    'funlangServer',
    'FunLang Language Server',
    serverOptions,
    clientOptions
  );

  // Start the client (and server)
  client.start();
}

export function deactivate(): Thenable<void> | undefined {
  if (!client) {
    return undefined;
  }
  return client.stop();
}
```

IMPORTANT: The server path assumes:
- Development: `dotnet run` to run the server project directly
- Production: Would use published executable

The path `../src/LangLSP.Server/LangLSP.Server.fsproj` assumes client/ and src/ are siblings.
Adjust based on actual project structure.
  </action>
  <verify>
`cd client && npm run compile` succeeds, producing `client/out/extension.js`
  </verify>
  <done>
Extension activates on .fun files and starts F# LSP server using dotnet run
  </done>
</task>

</tasks>

<verification>
1. `cd client && npm install && npm run compile` succeeds
2. `client/out/extension.js` is generated
3. Opening VS Code with the extension loaded (F5 from client folder) launches Extension Development Host
4. Opening a .fun file in Extension Development Host starts the LSP server
5. Typing errors in .fun file shows red squiggles
</verification>

<success_criteria>
- VS Code extension compiles without errors
- Extension activates automatically when .fun file is opened
- LanguageClient connects to F# server via stdio
- Diagnostics appear as red squiggles in editor
- Problems panel shows error messages
</success_criteria>

<output>
After completion, create `.planning/phases/01-lsp-foundation/01-06-SUMMARY.md`
</output>
