---
phase: 01-lsp-foundation
plan: 07
type: execute
wave: 5
depends_on: ["01-05", "01-06"]
files_modified:
  - docs/tutorial/04-document-sync.md
  - docs/tutorial/05-diagnostics.md
autonomous: true

must_haves:
  truths:
    - "Reader understands Document Sync protocol and implementation"
    - "Reader understands Diagnostics protocol and implementation"
    - "Code examples match the actual implementation"
  artifacts:
    - path: "docs/tutorial/04-document-sync.md"
      provides: "Document Sync implementation tutorial in Korean"
      contains: "didOpen"
      min_lines: 100
    - path: "docs/tutorial/05-diagnostics.md"
      provides: "Diagnostics implementation tutorial in Korean"
      contains: "publishDiagnostics"
      min_lines: 100
  key_links: []
---

<objective>
Write tutorials explaining Document Sync and Diagnostics implementation based on the completed code.

Purpose: Helps readers understand the implementation details after seeing the concepts.
Output: Two detailed tutorials with code walkthroughs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-lsp-foundation/01-RESEARCH.md
@.planning/phases/01-lsp-foundation/01-03-SUMMARY.md
@.planning/phases/01-lsp-foundation/01-05-SUMMARY.md

# Implemented source files for accurate code examples
@src/LangLSP.Server/DocumentSync.fs
@src/LangLSP.Server/Diagnostics.fs
@src/LangLSP.Server/Protocol.fs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Document Sync Tutorial (TUT-04)</name>
  <files>docs/tutorial/04-document-sync.md</files>
  <action>
Write `04-document-sync.md` in Korean covering:

1. **문서 동기화란** (What is Document Sync)
   - LSP에서 서버가 에디터의 문서 상태를 추적하는 방법
   - 파일 시스템이 아닌 메모리 기반 (저장하지 않은 변경도 추적)
   - 세 가지 이벤트: didOpen, didChange, didClose

2. **동기화 모드** (Sync Modes)
   - Full Sync: 변경마다 전체 텍스트 전송
   - Incremental Sync: 변경된 범위만 전송
   - 왜 Incremental이 더 효율적인가
   - ServerCapabilities에서 선언:
     ```fsharp
     TextDocumentSync = Some {
         Change = Some TextDocumentSyncKind.Incremental
     }
     ```

3. **ConcurrentDictionary로 문서 저장** (Document Storage)
   - 왜 ConcurrentDictionary인가 (스레드 안전성)
   - URI -> 텍스트 매핑
   - 코드 예제 (실제 DocumentSync.fs에서)

4. **didOpen 핸들러** (didOpen Handler)
   - DidOpenTextDocumentParams 구조
   - URI, LanguageId, Version, Text 추출
   - 저장 및 진단 트리거
   - 코드 예제

5. **didChange 핸들러** (didChange Handler)
   - TextDocumentContentChangeEvent 구조
   - Full sync vs Incremental sync 처리
   - Range 기반 텍스트 교체 알고리즘
   - 코드 예제 (applyContentChanges 함수)

6. **didClose 핸들러** (didClose Handler)
   - 문서 제거
   - 진단 클리어 (빈 배열 전송)
   - 코드 예제

7. **테스트 작성** (Writing Tests)
   - Expecto 테스트 예제
   - 테스트 케이스: 열기, 닫기, full sync, incremental sync

Include actual code snippets from the implemented DocumentSync.fs.
Target length: 150-200 lines.
  </action>
  <verify>
File exists at `docs/tutorial/04-document-sync.md` with all 7 sections, Korean text, and at least 100 lines
  </verify>
  <done>
Tutorial explains Document Sync implementation with code examples matching actual implementation
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Diagnostics Tutorial (TUT-05)</name>
  <files>docs/tutorial/05-diagnostics.md</files>
  <action>
Write `05-diagnostics.md` in Korean covering:

1. **진단이란** (What are Diagnostics)
   - LSP의 textDocument/publishDiagnostics 알림
   - Diagnostic 구조: Range, Severity, Code, Message
   - 에러, 경고, 정보, 힌트 수준

2. **FunLang의 Diagnostic 시스템** (FunLang's Diagnostic System)
   - Ast.fs의 Span 타입 (1-based line/column)
   - Diagnostic.fs의 Diagnostic 타입
   - TypeCheck.typecheckWithDiagnostic 함수
   - typeErrorToDiagnostic 변환

3. **위치 변환: Span -> LSP Range** (Position Conversion)
   - FunLang: 1-based (사람이 읽기 편함)
   - LSP: 0-based (프로그래머 관례)
   - spanToLspRange 함수
   - FsCheck로 속성 기반 테스트
   ```fsharp
   let spanToLspRange (span: Span) : Range =
       {
           Start = { Line = uint32 (span.StartLine - 1); ... }
           ...
       }
   ```

4. **문법 오류 처리** (Handling Syntax Errors)
   - Parser.program 호출 시 예외 catch
   - 예외에서 위치 정보 추출 (가능한 경우)
   - Diagnostic 생성
   - 코드 예제

5. **타입 오류 처리** (Handling Type Errors)
   - TypeCheck.typecheckWithDiagnostic 호출
   - Result 패턴 매칭 (Ok/Error)
   - diagnosticToLsp로 변환
   - 코드 예제

6. **publishDiagnostics 호출** (Calling publishDiagnostics)
   - 문서 변경 시마다 호출
   - PublishDiagnosticsParams 구조
   - 콜백 패턴 (서버에서 주입)
   - 코드 예제

7. **진단 클리어** (Clearing Diagnostics)
   - 문서 닫힐 때 빈 배열 전송
   - 왜 필요한가 (Problems 패널 정리)
   - clearDiagnostics 함수

8. **테스트 작성** (Writing Tests)
   - 유효한 코드 -> 진단 없음
   - 문법 오류 -> 진단 있음
   - 타입 오류 -> 진단 있음
   - FsCheck 속성 기반 테스트 (위치 변환)

Include actual code snippets from Diagnostics.fs and Protocol.fs.
Target length: 180-250 lines.
  </action>
  <verify>
File exists at `docs/tutorial/05-diagnostics.md` with all 8 sections, Korean text, and at least 100 lines
  </verify>
  <done>
Tutorial explains Diagnostics implementation with Span conversion and FunLang integration
  </done>
</task>

</tasks>

<verification>
1. `docs/tutorial/04-document-sync.md` exists with all sections
2. `docs/tutorial/05-diagnostics.md` exists with all sections
3. Code examples match actual implementation
4. Position conversion (1-based to 0-based) is clearly explained
5. Both tutorials reference FunLang's Diagnostic module
</verification>

<success_criteria>
- Document Sync tutorial explains didOpen/didChange/didClose handlers
- Diagnostics tutorial explains Span-to-LSP conversion
- Code examples are accurate and copy-able
- FsCheck testing strategy is explained
- Reader can understand and modify the implementation
</success_criteria>

<output>
After completion, create `.planning/phases/01-lsp-foundation/01-07-SUMMARY.md`
</output>
