---
phase: 05-vs-code-extension
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - client/src/extension.ts
  - client/.vscodeignore
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "extension.ts detects production mode (server/ directory exists) vs development mode (dotnet run)"
    - "dotnet publish produces server binary in client/server/ directory"
    - "vsce package produces a .vsix file in client/ directory"
    - ".vscodeignore excludes src/, node_modules/, tsconfig.json but includes out/, server/, syntaxes/, snippets/, images/"
    - "code --install-extension on the .vsix file succeeds"
  artifacts:
    - path: "client/src/extension.ts"
      provides: "LSP client with production/development mode detection"
      min_lines: 40
    - path: "client/.vscodeignore"
      provides: "VSIX package exclusion rules"
      min_lines: 8
  key_links:
    - from: "client/src/extension.ts"
      to: "client/server/"
      via: "fs.existsSync check for production mode"
      pattern: "existsSync.*server"
    - from: "client/.vscodeignore"
      to: "client/server/"
      via: "exclusion rule allowing server/ in VSIX"
      pattern: "!server"
---

<objective>
Update extension.ts for production/development mode, configure .vscodeignore, and build the .vsix package (EXT-04).

Purpose: The extension needs to work both in development (dotnet run) and when installed from a .vsix (bundled server binary). This plan bridges the gap from development extension to distributable package.
Output: Updated extension.ts with mode detection, clean .vscodeignore, successful `vsce package` producing funlang-0.1.0.vsix.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-vs-code-extension/05-RESEARCH.md
@client/src/extension.ts
@client/package.json
@client/.vscodeignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update extension.ts for production/development mode detection</name>
  <files>client/src/extension.ts, client/.vscodeignore</files>
  <action>
**client/src/extension.ts** -- Update to detect production vs development mode:

Replace the current `serverOptions` section with mode detection logic. The rest of the file (imports, client creation, deactivate) stays the same.

```typescript
import * as path from 'path';
import * as fs from 'fs';
import { workspace, ExtensionContext } from 'vscode';
import {
  LanguageClient,
  LanguageClientOptions,
  ServerOptions
} from 'vscode-languageclient/node';

let client: LanguageClient;

export function activate(context: ExtensionContext) {
  // Detect whether running from VSIX (production) or development
  const serverDir = context.asAbsolutePath(path.join('server'));

  let serverOptions: ServerOptions;

  if (fs.existsSync(serverDir)) {
    // Production: use published server binary from VSIX
    const serverPath = path.join(serverDir, 'LangLSP.Server');
    serverOptions = {
      run: { command: serverPath, options: { cwd: serverDir } },
      debug: { command: serverPath, options: { cwd: serverDir } }
    };
  } else {
    // Development: use dotnet run
    serverOptions = {
      run: {
        command: 'dotnet',
        args: ['run', '--project', context.asAbsolutePath(
          path.join('..', 'src', 'LangLSP.Server', 'LangLSP.Server.fsproj')
        )],
        options: { cwd: context.asAbsolutePath('..') }
      },
      debug: {
        command: 'dotnet',
        args: ['run', '--project', context.asAbsolutePath(
          path.join('..', 'src', 'LangLSP.Server', 'LangLSP.Server.fsproj')
        )],
        options: { cwd: context.asAbsolutePath('..') }
      }
    };
  }

  // Client options: what documents to sync
  const clientOptions: LanguageClientOptions = {
    documentSelector: [{ scheme: 'file', language: 'funlang' }],
    synchronize: {
      fileEvents: workspace.createFileSystemWatcher('**/*.fun')
    }
  };

  // Create and start the client
  client = new LanguageClient(
    'funlangServer',
    'FunLang Language Server',
    serverOptions,
    clientOptions
  );

  // Start the client (and server)
  client.start();
}

export function deactivate(): Thenable<void> | undefined {
  if (!client) {
    return undefined;
  }
  return client.stop();
}
```

Key change: Added `import * as fs from 'fs'` and the `if (fs.existsSync(serverDir))` block that switches between production (bundled binary) and development (dotnet run) modes.

After updating extension.ts, compile TypeScript:
```bash
cd client && npm run compile
```

**client/.vscodeignore** -- Replace with clean exclusion rules:

```
.vscode/**
src/**
node_modules/**
tsconfig.json
test.fun
*.ts
!out/**
!server/**
!syntaxes/**
!snippets/**
!images/**
!language-configuration.json
```

Changes from current:
- ADD `test.fun` exclusion (test file not needed in VSIX)
- ADD `*.ts` exclusion (source files not needed, only compiled JS)
- ADD `!out/**` to explicitly include compiled output
- ADD `!server/**` to include published server binary
- ADD `!syntaxes/**` to include TextMate grammar
- ADD `!snippets/**` to include code snippets
- ADD `!images/**` to include extension icon
- ADD `!language-configuration.json` to explicitly include language config
  </action>
  <verify>
```bash
cd /home/shoh/vibe-coding/LangLSP/client && npm run compile
# TypeScript compiles with no errors
# out/extension.js exists and contains fs.existsSync
```
  </verify>
  <done>
extension.ts detects production/development mode via fs.existsSync(serverDir). .vscodeignore properly excludes dev files and includes all extension assets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Publish server and package VSIX</name>
  <files>.gitignore</files>
  <action>
This task runs build commands to produce the .vsix file. No source files are modified.

**Step 1: Install @vscode/vsce** (if not already available):
```bash
cd /home/shoh/vibe-coding/LangLSP/client && npm install --save-dev @vscode/vsce
```

**Step 2: Publish F# server to client/server/**:
```bash
cd /home/shoh/vibe-coding/LangLSP && dotnet publish src/LangLSP.Server/LangLSP.Server.fsproj -c Release -o client/server
```

This creates a framework-dependent publish (requires .NET runtime on target machine). The output goes to `client/server/` which extension.ts checks for production mode.

**Step 3: Package VSIX**:
```bash
cd /home/shoh/vibe-coding/LangLSP/client && npx vsce package --allow-missing-repository
```

The `--allow-missing-repository` flag suppresses the warning about missing repository field in package.json. Output should be `funlang-0.1.0.vsix` in the client/ directory.

**Step 4: Verify VSIX was created**:
```bash
ls -la /home/shoh/vibe-coding/LangLSP/client/funlang-0.1.0.vsix
```

**Step 5: Create .gitignore for build artifacts**:
The project does not have a `.gitignore` yet. Create one at the project root to exclude build artifacts:
```bash
cat > /home/shoh/vibe-coding/LangLSP/.gitignore << 'EOF'
# Build artifacts
client/server/
client/*.vsix
EOF
```

IMPORTANT: This creates a NEW `.gitignore` file (none exists currently).

IMPORTANT: Do NOT commit the server/ directory or .vsix file to git. These are build artifacts.

If `vsce package` fails:
- Check that `publisher` field exists in package.json (should be "funlang")
- Check that `icon` file exists (images/funlang-icon.png)
- Check that all contributed files exist (syntaxes/, snippets/)
- If icon is missing or invalid, temporarily remove the `icon` field from package.json to unblock packaging, then fix the icon
  </action>
  <verify>
```bash
ls -la /home/shoh/vibe-coding/LangLSP/client/funlang-0.1.0.vsix
# .vsix file exists and has non-zero size
ls /home/shoh/vibe-coding/LangLSP/client/server/LangLSP.Server*
# Server binary exists in client/server/
```
  </verify>
  <done>
dotnet publish creates server binary in client/server/. vsce package produces funlang-0.1.0.vsix. Build artifacts excluded from git. EXT-04 requirement met.
  </done>
</task>

</tasks>

<verification>
```bash
# Extension compiles
cd /home/shoh/vibe-coding/LangLSP/client && npm run compile

# Server published
ls /home/shoh/vibe-coding/LangLSP/client/server/LangLSP.Server*

# VSIX packaged
ls /home/shoh/vibe-coding/LangLSP/client/funlang-0.1.0.vsix

# VSIX contains expected files (peek inside)
cd /home/shoh/vibe-coding/LangLSP/client && npx vsce ls
```
</verification>

<success_criteria>
- EXT-04 met: .vsix file successfully packaged
- extension.ts has production/development mode detection
- .vscodeignore properly filters VSIX contents
- Server binary bundled in client/server/
- Build artifacts (server/, *.vsix) not committed to git
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-vs-code-extension/05-03-SUMMARY.md`
</output>
