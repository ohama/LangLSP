---
phase: 04-advanced-features
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - documentation/tutorial/09-find-references.md
autonomous: true

must_haves:
  truths:
    - "Tutorial explains Find References concept with VS Code usage example"
    - "Tutorial shows LSP protocol for textDocument/references with request/response JSON"
    - "Tutorial walks through collectReferences and scope-aware reference collection implementation"
    - "Tutorial includes working code examples that match actual References.fs implementation"
    - "Tutorial covers shadowing handling with concrete examples"
    - "Tutorial shows Server.fs integration and test examples"
  artifacts:
    - path: "documentation/tutorial/09-find-references.md"
      provides: "Find References tutorial in Korean (TUT-09)"
      min_lines: 400
  key_links:
    - from: "documentation/tutorial/09-find-references.md"
      to: "src/LangLSP.Server/References.fs"
      via: "code examples matching implementation"
      pattern: "collectReferences|handleReferences"
---

<objective>
Write the Find References Korean tutorial (TUT-09) explaining how to implement textDocument/references.

Purpose: Tutorial readers learn how to implement Find All References, understand scope-aware reference collection, and handle variable shadowing.
Output: documentation/tutorial/09-find-references.md (~500-700 lines, Korean)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/LangLSP.Server/References.fs
@src/LangLSP.Server/AstLookup.fs
@src/LangLSP.Server/Definition.fs
@documentation/tutorial/08-definition.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Find References tutorial (09-find-references.md)</name>
  <files>documentation/tutorial/09-find-references.md</files>
  <action>
Create `documentation/tutorial/09-find-references.md` in Korean, following the style and format of existing tutorials (especially 08-definition.md).

Title: `# Find References 구현하기`

Opening paragraph: Explain that this document covers implementing Find References — finding all places where a variable or function is used across the code. Describe why this is essential for code navigation and understanding.

Structure (follow 08-definition.md table of contents pattern):

## 목차
1. Find References란
2. LSP 프로토콜
3. Definition과의 관계
4. 레퍼런스 수집 구현
5. 스코프 인식 레퍼런스 수집
6. 변수 섀도잉 처리
7. 핸들러 구현
8. Server.fs 통합
9. 테스트 작성
10. Definition vs References 비교

## Content for each section:

**1. Find References란**
- What it does: find all usage locations of a symbol
- VS Code usage: right-click -> "Find All References" or Shift+F12
- Show text diagram like 08-definition.md:
  ```
  test.fun
  ────────
  1 | let x = 42 in
  2 | let y = x + 1 in
          ^ Reference 1
  3 | x + y
      ^ Reference 2
  ```
- Explain difference from Go to Definition (inverse operation)

**2. LSP 프로토콜**
- textDocument/references request
- Show ReferenceParams JSON with TextDocumentIdentifier, Position, ReferenceContext (includeDeclaration)
- Show response: Location[] with uri and range
- Explain ReferenceContext.IncludeDeclaration flag
- Server capability: ReferencesProvider = true

**3. Definition과의 관계**
- Definition finds where symbol is declared (1 location)
- References finds where symbol is used (N locations)
- They are inverse operations
- References reuses Definition.collectDefinitions and findDefinitionForVar
- Diagram showing the relationship

**4. 레퍼런스 수집 구현**
- Show collectReferences function with full code
- Explain AST traversal strategy: collect all Var nodes matching name
- Walk through each Expr case
- Compare with collectDefinitions (definitions collect binding sites, references collect usage sites)

**5. 스코프 인식 레퍼런스 수집**
- Problem: simple name matching finds references to wrong binding when shadowed
- Show concrete example: `let x = 1 in (let x = 2 in x) + x`
- Explain collectReferencesForBinding: cross-check each Var's definition to match target binding
- Show code with comments explaining the scope resolution strategy
- Uses findDefinitionForVar to determine which binding each Var refers to

**6. 변수 섀도잉 처리**
- Detailed walkthrough of shadowing scenario
- Step-by-step trace of how collectReferencesForBinding resolves each Var
- Edge cases: nested shadowing, lambda parameters shadowing let bindings

**7. 핸들러 구현**
- Show handleReferences function code
- Explain: parse -> find node -> collect references -> optionally include declaration -> convert to Location[]
- Handle both Var nodes and binding sites at cursor

**8. Server.fs 통합**
- Show capability registration: ReferencesProvider = Some (U2.C1 true)
- Show handler function in Handlers module
- Explain VS Code → server flow

**9. 테스트 작성**
- Show 2-3 test examples from ReferencesTests.fs
- Test for basic references, includeDeclaration, shadowing
- Show test helpers pattern (setupAndFindReferences)

**10. Definition vs References 비교**
- Summary table comparing the two features
- When to use each
- How they complement each other

STYLE GUIDELINES (from existing tutorials):
- Korean language throughout
- Backtick code references for function names, types, file paths
- Fenced code blocks with language tag (fsharp, json)
- Section dividers with ---
- Practical tone, concrete examples
- ~500-700 lines total
- Include actual implementation code (matching References.fs)
  </action>
  <verify>
File exists at documentation/tutorial/09-find-references.md with 400+ lines. Contains Korean text, code examples, all 10 sections.
  </verify>
  <done>
Tutorial 09-find-references.md written in Korean covering Find References concept, LSP protocol, implementation with scope-aware collection, shadowing handling, server integration, and tests (TUT-09).
  </done>
</task>

</tasks>

<verification>
- documentation/tutorial/09-find-references.md exists with 400+ lines
- All 10 sections present
- Code examples match actual References.fs implementation
- Korean language throughout
</verification>

<success_criteria>
- TUT-09 requirement met: tutorial shows how to implement Find References with code examples
- Tutorial follows established format from 08-definition.md
- Covers scope-aware reference collection and shadowing (key differentiator from simple string search)
- Code examples are accurate and match implementation
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-features/04-04-SUMMARY.md`
</output>
