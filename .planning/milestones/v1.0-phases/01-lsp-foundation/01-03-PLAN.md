---
phase: 01-lsp-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/LangLSP.Server/DocumentSync.fs
  - src/LangLSP.Server/LangLSP.Server.fsproj
  - src/LangLSP.Server/Server.fs
  - src/LangLSP.Tests/LangLSP.Tests.fsproj
  - src/LangLSP.Tests/DocumentSyncTests.fs
autonomous: true

must_haves:
  truths:
    - "Server tracks open documents in memory"
    - "Server receives didOpen events and stores document text"
    - "Server receives didChange events and applies incremental changes"
    - "Server receives didClose events and removes document from tracking"
    - "All Document Sync unit tests pass"
  artifacts:
    - path: "src/LangLSP.Server/DocumentSync.fs"
      provides: "Document state management"
      exports: ["handleDidOpen", "handleDidChange", "handleDidClose", "getDocument"]
      min_lines: 50
    - path: "src/LangLSP.Tests/DocumentSyncTests.fs"
      provides: "Document Sync unit tests"
      contains: "testList"
      min_lines: 40
  key_links:
    - from: "src/LangLSP.Server/Server.fs"
      to: "src/LangLSP.Server/DocumentSync.fs"
      via: "handler registration"
      pattern: "DocumentSync"
    - from: "src/LangLSP.Server/DocumentSync.fs"
      to: "Ionide.LanguageServerProtocol.Types"
      via: "LSP event types"
      pattern: "DidOpenTextDocumentParams"
---

<objective>
Implement Document Synchronization (didOpen/didChange/didClose handlers) with thread-safe document storage and comprehensive unit tests.

Purpose: Document sync is the foundation for all LSP features - diagnostics, hover, completion all need access to current document state.
Output: Working document sync module with ConcurrentDictionary storage and Expecto tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-lsp-foundation/01-RESEARCH.md
@.planning/phases/01-lsp-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement DocumentSync Module</name>
  <files>
    src/LangLSP.Server/DocumentSync.fs
    src/LangLSP.Server/LangLSP.Server.fsproj
  </files>
  <action>
Create DocumentSync.fs implementing document state management:

```fsharp
module LangLSP.Server.DocumentSync

open System.Collections.Concurrent
open Ionide.LanguageServerProtocol.Types

/// Thread-safe document storage (URI -> text content)
let private documents = ConcurrentDictionary<string, string>()

/// Get document text by URI (for diagnostics, hover, etc.)
let getDocument (uri: string) : string option =
    match documents.TryGetValue(uri) with
    | true, text -> Some text
    | false, _ -> None

/// Handle textDocument/didOpen
let handleDidOpen (p: DidOpenTextDocumentParams) : unit =
    let uri = p.TextDocument.Uri
    let text = p.TextDocument.Text
    documents.[uri] <- text

/// Handle textDocument/didClose
let handleDidClose (p: DidCloseTextDocumentParams) : unit =
    let uri = p.TextDocument.Uri
    documents.TryRemove(uri) |> ignore

/// Apply incremental text changes to document
/// LSP changes are applied in order; each change has a Range to replace
let private applyContentChanges (text: string) (changes: TextDocumentContentChangeEvent[]) : string =
    changes
    |> Array.fold (fun currentText change ->
        match change.Range with
        | Some range ->
            // Incremental change: replace text at range
            let lines = currentText.Split([|'\n'|], System.StringSplitOptions.None)
            let startOffset = getOffset lines (int range.Start.Line) (int range.Start.Character)
            let endOffset = getOffset lines (int range.End.Line) (int range.End.Character)
            currentText.Substring(0, startOffset) + change.Text + currentText.Substring(endOffset)
        | None ->
            // Full sync fallback
            change.Text
    ) text

/// Convert line/character to string offset
/// Note: LSP positions are 0-based
let private getOffset (lines: string[]) (line: int) (character: int) : int =
    let mutable offset = 0
    for i in 0 .. line - 1 do
        if i < lines.Length then
            offset <- offset + lines.[i].Length + 1  // +1 for newline
    offset + min character (if line < lines.Length then lines.[line].Length else 0)

/// Handle textDocument/didChange
let handleDidChange (p: DidChangeTextDocumentParams) : unit =
    let uri = p.TextDocument.Uri
    match documents.TryGetValue(uri) with
    | true, currentText ->
        let newText = applyContentChanges currentText (Array.ofList p.ContentChanges)
        documents.[uri] <- newText
    | false, _ ->
        // Document not tracked - this shouldn't happen, but handle gracefully
        ()

/// Get all tracked document URIs (for testing)
let getTrackedDocuments () : string seq =
    documents.Keys :> seq<string>

/// Clear all documents (for testing)
let clearAll () : unit =
    documents.Clear()
```

Update LangLSP.Server.fsproj to include DocumentSync.fs BEFORE Server.fs in compile order.

IMPORTANT: The exact LSP types in Ionide 0.7.0 may differ slightly. Check:
- TextDocumentContentChangeEvent structure
- Whether Range is optional or wrapped
- ContentChanges may be array or list
  </action>
  <verify>
`dotnet build src/LangLSP.Server/LangLSP.Server.fsproj` compiles without errors
  </verify>
  <done>
DocumentSync.fs provides handleDidOpen, handleDidChange, handleDidClose, and getDocument functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Document Sync Handlers to Server</name>
  <files>src/LangLSP.Server/Server.fs</files>
  <action>
Update Server.fs to register DocumentSync handlers:

The exact API depends on Ionide.LanguageServerProtocol 0.7.0 server interface. The pattern is typically:

```fsharp
// In Server.fs, when creating the server handlers:
let textDocumentDidOpen = DocumentSync.handleDidOpen
let textDocumentDidChange = DocumentSync.handleDidChange
let textDocumentDidClose = DocumentSync.handleDidClose
```

The server creation in 0.7.0 likely uses:
- An interface implementation pattern (ILspServer)
- Or a record of handlers
- Or a builder pattern

Reference FsAutoComplete for the exact pattern. The key is connecting:
- `textDocument/didOpen` notification -> DocumentSync.handleDidOpen
- `textDocument/didChange` notification -> DocumentSync.handleDidChange
- `textDocument/didClose` notification -> DocumentSync.handleDidClose
  </action>
  <verify>
`dotnet build src/LangLSP.Server/LangLSP.Server.fsproj` compiles and Server.fs references DocumentSync module
  </verify>
  <done>
Server.fs wires DocumentSync handlers to LSP notifications
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Test Project and Document Sync Tests</name>
  <files>
    src/LangLSP.Tests/LangLSP.Tests.fsproj
    src/LangLSP.Tests/DocumentSyncTests.fs
  </files>
  <action>
Create test project:

1. Create `src/LangLSP.Tests/` directory

2. Create `LangLSP.Tests.fsproj`:
   - TargetFramework: net10.0
   - OutputType: Exe (Expecto runs as console)
   - PackageReferences:
     - Expecto 10.2.3
     - Expecto.FsCheck 10.2.3
   - ProjectReference to ../LangLSP.Server/LangLSP.Server.fsproj
   - Compile order: DocumentSyncTests.fs, Program.fs

3. Create DocumentSyncTests.fs:

```fsharp
module LangLSP.Tests.DocumentSyncTests

open Expecto
open LangLSP.Server.DocumentSync
open Ionide.LanguageServerProtocol.Types

let makeDidOpenParams uri text =
    { TextDocument = { Uri = uri; LanguageId = "funlang"; Version = 1; Text = text } }

let makeDidCloseParams uri =
    { TextDocument = { Uri = uri } }

let makeDidChangeParams uri version changes =
    {
        TextDocument = { Uri = uri; Version = version }
        ContentChanges = changes
    }

[<Tests>]
let documentSyncTests =
    testList "DocumentSync" [

        testCase "didOpen stores document text" <| fun _ ->
            clearAll()
            let uri = "file:///test.fun"
            let text = "let x = 1"
            handleDidOpen (makeDidOpenParams uri text)
            Expect.equal (getDocument uri) (Some text) "Document should be stored"

        testCase "didClose removes document" <| fun _ ->
            clearAll()
            let uri = "file:///test.fun"
            handleDidOpen (makeDidOpenParams uri "let x = 1")
            handleDidClose (makeDidCloseParams uri)
            Expect.equal (getDocument uri) None "Document should be removed"

        testCase "didChange with full sync replaces text" <| fun _ ->
            clearAll()
            let uri = "file:///test.fun"
            handleDidOpen (makeDidOpenParams uri "let x = 1")
            let change = { Range = None; RangeLength = None; Text = "let y = 2" }
            handleDidChange (makeDidChangeParams uri 2 [change])
            Expect.equal (getDocument uri) (Some "let y = 2") "Text should be replaced"

        testCase "didChange with incremental sync modifies range" <| fun _ ->
            clearAll()
            let uri = "file:///test.fun"
            handleDidOpen (makeDidOpenParams uri "let x = 1")
            // Change 'x' to 'y' (position 4, length 1)
            let range = { Start = { Line = 0u; Character = 4u }; End = { Line = 0u; Character = 5u } }
            let change = { Range = Some range; RangeLength = Some 1u; Text = "y" }
            handleDidChange (makeDidChangeParams uri 2 [change])
            Expect.equal (getDocument uri) (Some "let y = 1") "Variable name should be changed"

        testCase "getDocument returns None for unknown URI" <| fun _ ->
            clearAll()
            Expect.equal (getDocument "file:///unknown.fun") None "Unknown document should return None"
    ]
```

4. Create Program.fs:

```fsharp
module LangLSP.Tests.Program

open Expecto

[<EntryPoint>]
let main argv =
    runTestsInAssemblyWithCLIArgs [] argv
```

NOTE: The exact TextDocumentContentChangeEvent structure in Ionide 0.7.0 needs verification. Adjust field names if needed.
  </action>
  <verify>
`dotnet test src/LangLSP.Tests/LangLSP.Tests.fsproj` runs and all 5 tests pass
  </verify>
  <done>
Test project exists with 5 Document Sync unit tests, all passing
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/LangLSP.Server/LangLSP.Server.fsproj` succeeds
2. `dotnet test src/LangLSP.Tests/LangLSP.Tests.fsproj` shows 5 passing tests
3. DocumentSync module exports handleDidOpen, handleDidChange, handleDidClose, getDocument
4. Server.fs references DocumentSync handlers
</verification>

<success_criteria>
- Document sync handlers store/update/remove documents correctly
- Incremental text changes are applied at correct positions
- Thread-safe ConcurrentDictionary used for document storage
- 5 unit tests cover: didOpen, didClose, full sync, incremental sync, unknown document
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-lsp-foundation/01-03-SUMMARY.md`
</output>
